<form>
  <div class="header-light my-2" style="padding: 5px 8px 5px 12px;background-color: var(--card-header-bg) !important">
    <!-- <div
      class="attribute w-100"
      [ngStyle]="{ opacity: currentControl ? 1 : 0 }"
    >
      <label *ngIf="currentControl" for="">{{
        this.getAttributeObjectById(currentControl.parent.value.attributeId)
          ?.description
      }}</label>
      <input
        [ngClass]="{ highlight: currentControl }"
        class="width-perc-100"
        [(ngModel)]="formulaValue"
        [ngModelOptions]="{ standalone: true }"
        (input)="openFormulaAutoComplete($event)"
        type="text"
        placeholder="Formula"
      />
    </div>

    <div class="formula-autocomplete b-light" *ngIf="formulaAutoComplete">
      <p
        style="cursor: pointer"
        (click)="
          selectFormulaAttribute(
            this.getAttributeObjectById(attribute?.attributeId)?.description
          )
        "
        *ngFor="
          let attribute of getFilteredAutoCompleteAttributes();
          let i = index
        "
      >
        {{ this.getAttributeObjectById(attribute?.attributeId)?.description }}
      </p>
      <ng-container
        *ngFor="let att of lastProcessProcessProducts?.controls; let k = index"
      >
        <ng-container
          *ngFor="
            let processProductAttribute of getProcessProductAttributeValues(k)
              .controls | sortFormArray;
            let l = index
          "
        >
          <p
            style="cursor: pointer"
            (click)="
              selectFormulaAttribute(
                '[Process].[Layer]' +
                  k +
                  '].' +
                  this.getAttributeObjectById(
                    processProductAttribute.value.attributeId
                  )?.description
              )
            "
            *ngIf="
              !layerWiselabelTypeAttributeIds[
                att?.value.subProductId + '' + l
              ]?.includes(processProductAttribute.value.attributeId)
            "
          >
            Layer[{{ k }}].{{
              this.getAttributeObjectById(
                processProductAttribute.value.attributeId
              )?.description
            }}
          </p>
        </ng-container>
      </ng-container>
    </div> -->

     <div class="b-round my-2 d-flex w-75 bg-card-header">
      <div class="title-text ">
        <strong class="mr-2" style="white-space: pre;"> Product Attribute Calculator </strong>
        <dadyin-button
          (click)="testCalculatorModal()"
          tooltip="Test Product Calculator"
          [theme]="'borderless-primary'"
          [typeval]="'assets/nicons/calculator.png'"
          [type]="'image'"
          [class]="'w-auto-img'"
        >
        </dadyin-button>
      </div>
      <div class="position-relative w-50">
        <div
      class="attribute w-100"
      [ngStyle]="{ opacity: currentControl ? 1 : 0 }"
    >
      <label *ngIf="currentControl" for="">{{
        this.getAttributeObjectById(currentControl.parent.value.attributeId)
          ?.description
      }}</label>
      <input
        [ngClass]="{ highlight: currentControl }"
        class="width-perc-100"
        [(ngModel)]="formulaValue"
        [ngModelOptions]="{ standalone: true }"
        (input)="openFormulaAutoComplete($event)"
        type="text"
        placeholder="Formula"
      />
    </div>

    <div class="formula-autocomplete b-light" *ngIf="formulaAutoComplete">
      <p
        style="cursor: pointer"
        (click)="
          selectFormulaAttribute(
            this.getAttributeObjectById(attribute?.attributeId)?.description
          )
        "
        *ngFor="
          let attribute of getFilteredAutoCompleteAttributes();
          let i = index
        "
      >
        {{ this.getAttributeObjectById(attribute?.attributeId)?.description }}
      </p>
      <ng-container
        *ngFor="let att of lastProcessProcessProducts?.controls; let k = index"
      >
        <ng-container
          *ngFor="
            let processProductAttribute of getProcessProductAttributeValues(k)
              .controls | sortFormArray;
            let l = index
          "
        >
          <p
            style="cursor: pointer"
            (click)="
              selectFormulaAttribute(
                '[Process].[Layer]' +
                  k +
                  '].' +
                  this.getAttributeObjectById(
                    processProductAttribute.value.attributeId
                  )?.description
              )
            "
            *ngIf="
              !layerWiselabelTypeAttributeIds[
                att?.value.subProductId + '' + l
              ]?.includes(processProductAttribute.value.attributeId)
            "
          >
            Layer[{{ k }}].{{
              this.getAttributeObjectById(
                processProductAttribute.value.attributeId
              )?.description
            }}
          </p>
        </ng-container>
      </ng-container>
    </div> 
</div>
    </div>

 
<div class="d-flex align-items-center" >
    <dadyin-button
      (click)="resetFormula()"
      [theme]="'borderless-primary'"
      type="icon"
      [typeval]="'replay'"
       [class]="'bg-white'"
    >
    </dadyin-button>
    &nbsp;
    <dadyin-button
      (click)="openDialog()"
      [theme]="'borderless-primary'"
       [class]="'bg-white px-2 w-auto-img'"
    type="image"
    [typeval]="'assets/nicons/info.png'"
    >
    </dadyin-button>
    </div>
  </div>

  <ng-container>
  <!--   <div class="panel-header b-round my-2 bg-card-header">
      <div class="title-text w-100">
        <strong class="mr-2"> Product Attribute Calculator </strong>
        <dadyin-button
          (click)="testCalculatorModal()"
          tooltip="Test Product Calculator"
          [theme]="'borderless-primary'"
          [typeval]="'calculate'"
          [type]="'icon'"
        >
        </dadyin-button>
      </div>
    </div> -->

    <div
      [formGroup]="productTemplateCalculator"
      class="toolbar padding-bar b-round height-40 my-2 d-flex justify-content-between width-perc-100"
    >
      <div class="d-flex align-items-center font-size-14 title-text">
        <div class="mx-1"><b> Product </b></div>
        <div class="attribute-group d-flex align-items-center">
          <select
            class="b-round"
            *ngIf="!showInputMeta"
            formControlName="metaCalculatorId"
            (change)="onSelectCalculatorMeta()"
          >
            <option value="null" disabled selected>
              <b> Select calculator </b>
            </option>
            <option [value]="'NEW'"><b> + Create new calculator </b></option>
            <option [value]="'SAVEAS'">
              <b> + Save as new calculator </b>
            </option>
            <ng-container *ngFor="let meta of apiService.allCalculatorMetas">
              <option *ngIf="meta.packageType == 'UNIT'" [value]="meta.id">
                {{ meta.description }}
              </option>
            </ng-container>
          </select>
          <input
            *ngIf="showInputMeta"
            [ngClass]="{ 'b-red': description.invalid }"
            type="text"
            [formControl]="description"
          />
          <dadyin-button
            *ngIf="showInputMeta"
            (click)="postCalculatorMeta()"
            [theme]="'borderless-primary'"
            type="image"
            [typeval]="'assets/nicons/save.png'"
            [isDisabled]="description.invalid"
          >
          </dadyin-button>
          <dadyin-button
            *ngIf="!showInputMeta"
            (click)="updateCalculatorMeta()"
            [theme]="'borderless-primary'"
            type="image"
            [typeval]="'assets/nicons/save.png'"
          >
          </dadyin-button>
          <dadyin-button
            *ngIf="showInputMeta"
            (click)="toggleSaveInput()"
            [theme]="'borderless-danger'"
            type="image"
            [typeval]="'assets/nicons/delete.png'"
          >
          </dadyin-button>
        </div>
        <div class="d-flex mx-1">
          <div class="">
            <strong>Template Cost : </strong>
            <span
              (mousedown)="preventFocusChange($event)"
              (click)="onClickLabel('MetricCost', '[Product].', 'Product')"
              class="price-text cursor"
            >
              {{ getTemplateCost() }}
            </span>
          </div>
          <div class=" mx-2">
            <strong>Template Density : </strong>
            <span
              (mousedown)="preventFocusChange($event)"
              (click)="onClickLabel('Density', '[Product].', 'Product')"
              class="price-text cursor"
            >
              {{ getTemplateDensity() }}
            </span>
          </div>
        </div>
      </div>

      <div class="options">
        <div class="d-flex">
          <input
            [formControl]="attributeName"
            [matAutocomplete]="auto"
            type="text"
            placeholder="Type new field to add"
          />
          <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete">
            <mat-option
              *ngFor="
                let attribute of getFilteredAttributes()
                  | SortNamePipe : 'description'
              "
              [value]="attribute.description"
            >
              {{ attribute.description }}
            </mat-option>
          </mat-autocomplete>
          <select class="width-perc-100 b-round bg-light" [formControl]="attributeType">
            <option value="null" selected>Attribute Type</option>
            <option
              [value]="attributeType.id"
              *ngFor="
                let attributeType of this.apiService.allAttributesTypes
                  | SortNamePipe : 'description'
              "
            >
              {{ attributeType.description }}
            </option>
          </select>
        </div>
        <div class="px-1">
          <select class="b-round" [formControl]="colSpace">
            <option value="" selected disabled>Field Space</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="75">75</option>
            <option value="100">100</option>
          </select>
        </div>
        <dadyin-button
          class="px-1"
          [typeval]="'assets/nicons/add-white.png'"
          type="image"
         [theme]="'borderless-primary'"
          [isDisabled]="!attributeType.value || !attributeName.value"
          (clicked)="addAttribute('calculator')"
        >
        </dadyin-button>
        <dadyin-button
          (click)="openAttributeDialog()"
          [theme]="'borderless-primary'"
          class="sort-btn bg-white"
          type="icon"
          [typeval]="'sort'"
        >
        </dadyin-button>

        <dadyin-button
          (clicked)="changeView(0)"
          [theme]="'borderless-primary'"
          class="bg-white mx-1"
          type="icon"
          [typeval]="'format_list_numbered'"
        >
        </dadyin-button>
      </div>
    </div>
    <section
      class="card"
      style="
        overflow-y: auto;
        overflow-x: hidden;
        max-height: 500px;
        margin-bottom: 60px !important;
      "
    >
      <ul class="attribute-groups">
        <li class="attribute-group">
          <div class="d-flex w-100">
            <div
              class="row py-3 w-100"
              *ngIf="
                productCalculatorTemplateAttributeValues.controls?.length > 0
              "
            >
              <ng-container *ngIf="!excelView[0]">
                <ng-container
                  [formGroup]="item"
                  *ngFor="
                    let item of productCalculatorTemplateAttributeValues.controls
                      | sortFormArray;
                    let i = index
                  "
                >
                  <ng-container
                    *ngIf="
                      !labelTypeAttributeIds.includes(
                        item.get('attributeId').value
                      )
                    "
                  >
                    <ng-container
                      *ngIf="
                        !['Toggle', 'Dropdown', 'Label'].includes(
                          getAttributeTypeObjectById(
                            this.getAttributeObjectById(
                              item?.get('attributeId').value
                            )?.attributeTypeId
                          )?.description
                        )
                      "
                    >
                      <div
                        [ngClass]="{
                          'width-perc-25': item?.get('colSpace').value == 25,
                          'width-perc-50': item?.get('colSpace').value == 50,
                          'width-perc-75': item?.get('colSpace').value == 75,
                          'width-perc-100': item?.get('colSpace').value == 100
                        }"
                        class="my-1"
                      >
                        <div class="attribute one attr-b">
                          <label
                            (mousedown)="preventFocusChange($event)"
                            (click)="
                              onClickLabel(
                                this.getAttributeObjectById(
                                  item?.get('attributeId').value
                                )?.description,
                                '[Product].',
                                'Product'
                              )
                            "
                            for=""
                          >
                            {{
                              this.getAttributeObjectById(
                                item?.get("attributeId").value
                              )?.description
                            }}</label
                          >
                          <div class="attribute-input">
                            <mat-icon
                              (click)="onDragClickAttribute(i)"
                              class="more_vert"
                              >more_vert
                            </mat-icon>
                            <mat-icon
                              *ngIf="!item?.get('isHidden').value"
                              (click)="toggleVisibility(item, true)"
                              class="visibility"
                              >visibility
                            </mat-icon>
                            <mat-icon
                              *ngIf="item?.get('isHidden').value"
                              (click)="toggleVisibility(item, false)"
                              class="visibility_off"
                              >visibility_off
                            </mat-icon>
                            <input
                              [ngClass]="{
                                highlight: currentFocusedIndex == i + 'Product'
                              }"
                              type="text"
                              (focus)="
                                formula(
                                  item?.get('attributeValueExpression'),
                                  i + 'Product'
                                )
                              "
                              (input)="
                                formula(
                                  item?.get('attributeValueExpression'),
                                  i + 'Product'
                                )
                              "
                              formControlName="attributeValueExpression"
                              placeholder="Enter your value"
                            />
                            <ng-container
                              *ngIf="
                                getAttributeTypeObjectById(
                                  this.getAttributeObjectById(
                                    item?.get('attributeId').value
                                  )?.attributeTypeId
                                )?.availableUOMs?.length > 0
                              "
                            >
                              <select class="bg-light"
                                tabindex="-1"
                                *ngIf="
                                  !['Number', 'String'].includes(
                                    getAttributeTypeObjectById(
                                      getAttributeObjectById(
                                        item?.get('attributeId').value
                                      )?.attributeTypeId
                                    ).description
                                  )
                                "
                                formControlName="userConversionUom"
                                id="userConversionUom"
                              >
                                <option
                                  [value]="uom.description"
                                  *ngFor="
                                    let uom of getAttributeTypeObjectById(
                                      this.getAttributeObjectById(
                                        item?.get('attributeId').value
                                      )?.attributeTypeId,
                                      item?.get('userConversionUom')
                                    ).availableUOMs
                                  "
                                >
                                  {{ uom?.description }}
                                </option>
                              </select>
                            </ng-container>

                            <ng-container
                              *ngIf="
                                ['Number', 'String'].includes(
                                  getAttributeTypeObjectById(
                                    getAttributeObjectById(
                                      item?.get('attributeId').value
                                    )?.attributeTypeId
                                  ).description
                                )
                              "
                            >
                              <div class="uom-label">
                                {{ item?.get("userConversionUom").value ?? "" }}
                              </div>
                            </ng-container>
                         
                              <dadyin-button matTooltip="Delete" 
                              (clicked)="removeProductCalculatorAttribute(i)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                          </div>
                        </div>
                      </div>
                    </ng-container>

                    <ng-container
                      *ngIf="
                        ['Toggle'].includes(
                          getAttributeTypeObjectById(
                            this.getAttributeObjectById(
                              item?.get('attributeId').value
                            )?.attributeTypeId
                          )?.description
                        )
                      "
                    >
                      <div
                        [ngClass]="{
                          'width-perc-25': item.get('colSpace').value == 25,
                          'width-perc-50': item.get('colSpace').value == 50,
                          'width-perc-75': item.get('colSpace').value == 75,
                          'width-perc-100': item.get('colSpace').value == 100
                        }"
                        class="my-1"
                      >
                        <div class="attribute tabular-sheet d-flex attr-b">
                          <div class="attribute-input me-2">
                            <mat-icon
                              (click)="onDragClickAttribute(i)"
                              class="more_vert"
                              >more_vert
                            </mat-icon>
                            <mat-icon
                              *ngIf="!item?.get('isHidden').value"
                              (click)="toggleVisibility(item, true)"
                              class="visibility"
                              >visibility
                            </mat-icon>
                            <mat-icon
                              *ngIf="item?.get('isHidden').value"
                              (click)="toggleVisibility(item, false)"
                              class="visibility_off"
                              >visibility_off
                            </mat-icon>
                            <input
                              type="text"
                              [value]="
                                this.getAttributeObjectById(
                                  item?.get('attributeId').value
                                )?.description
                              "
                              readonly
                            />
                            <div class="toggle">
                              <button
                                [ngClass]="{
                                  active:
                                    getArray(
                                      item.get('attributeValueExpression').value
                                    )[0].selected == true
                                }"
                              >
                                {{
                                  getArray(
                                    item.get("attributeValueExpression").value
                                  )[0].choice
                                }}
                              </button>
                              <button
                                [ngClass]="{
                                  active:
                                    getArray(
                                      item.get('attributeValueExpression').value
                                    )[1].selected == true
                                }"
                              >
                                {{
                                  getArray(
                                    item.get("attributeValueExpression").value
                                  )[1].choice
                                }}
                              </button>
                       
                            </div>
                          </div>
                         
                            <dadyin-button matTooltip="Delete" 
                              (clicked)="removeProductCalculatorAttribute(i)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                        </div>
                      </div>
                    </ng-container>
                    <ng-container
                      *ngIf="
                        ['Dropdown'].includes(
                          getAttributeTypeObjectById(
                            this.getAttributeObjectById(
                              item?.get('attributeId').value
                            )?.attributeTypeId
                          )?.description
                        )
                      "
                    >
                      <div
                        [ngClass]="{
                          'width-perc-25': item.get('colSpace').value == 25,
                          'width-perc-50': item.get('colSpace').value == 50,
                          'width-perc-75': item.get('colSpace').value == 75,
                          'width-perc-100': item.get('colSpace').value == 100
                        }"
                        class="my-1"
                      >
                        <div class="attribute one attr-b">
                          <label
                            (mousedown)="preventFocusChange($event)"
                            (click)="
                              onClickLabel(
                                this.getAttributeObjectById(
                                  item?.get('attributeId').value
                                )?.description,
                                '[Product].',
                                'Product'
                              )
                            "
                            for=""
                          >
                            {{
                              this.getAttributeObjectById(
                                item?.get("attributeId").value
                              )?.description
                            }}</label
                          >
                          <div class="attribute-input">
                            <mat-icon
                              (click)="editDropdownAttribute(item, i)"
                              class="preview"
                              >preview
                            </mat-icon>
                            <mat-icon
                              (click)="onDragClickAttribute(i)"
                              class="more_vert"
                              >more_vert
                            </mat-icon>
                            <mat-icon
                              *ngIf="!item?.get('isHidden').value"
                              (click)="toggleVisibility(item, true)"
                              class="visibility"
                              >visibility
                            </mat-icon>
                            <mat-icon
                              *ngIf="item?.get('isHidden').value"
                              (click)="toggleVisibility(item, false)"
                              class="visibility_off"
                              >visibility_off
                            </mat-icon>
                            <select class="width-perc-100 bg-white">
                              <option
                                *ngFor="
                                  let opt of getArray(
                                    item.get('attributeValueExpression').value
                                  );
                                  trackBy: trackByFn
                                "
                                [value]="opt.choice"
                              >
                                {{ opt.choice }}
                              </option>
                            </select>
                          </div>
                   
                            <dadyin-button matTooltip="Delete" 
                              (clicked)="removeProductCalculatorAttribute(i)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                        </div>
                      </div>
                    </ng-container>
                    <ng-container
                      *ngIf="
                        ['Label'].includes(
                          getAttributeTypeObjectById(
                            this.getAttributeObjectById(
                              item?.get('attributeId').value
                            )?.attributeTypeId
                          )?.description
                        )
                      "
                    >
                      <div
                        class="width-perc-100 row b-all b-round mx-auto min-h-label p-0 attr-b relative"
                      >
                        <div class="labeltype-attribute">
                          {{
                            this.getAttributeObjectById(
                              item?.get("attributeId").value
                            )?.description
                          }}
                        </div>

                        <ng-container
                          [formGroup]="attr"
                          *ngFor="
                            let attr of filterAttributeForLabel(
                              productCalculatorTemplateAttributeValues
                            ) | sortFormArray
                          "
                        >
                          <ng-container>
                            <ng-container
                              *ngIf="
                                !['Toggle', 'Dropdown', 'Label'].includes(
                                  getAttributeTypeObjectById(
                                    this.getAttributeObjectById(
                                      attr?.get('attributeId').value
                                    )?.attributeTypeId
                                  )?.description
                                )
                              "
                            >
                              <div
                                [ngClass]="{
                                  'width-perc-25':
                                    attr?.get('colSpace').value == 25,
                                  'width-perc-50':
                                    attr?.get('colSpace').value == 50,
                                  'width-perc-75':
                                    attr?.get('colSpace').value == 75,
                                  'width-perc-100':
                                    attr?.get('colSpace').value == 100
                                }"
                                class="mt-3"
                              >
                                <div class="attribute one attr-b">
                                  <label
                                    (mousedown)="preventFocusChange($event)"
                                    (click)="
                                      onClickLabel(
                                        this.getAttributeObjectById(
                                          attr?.get('attributeId').value
                                        )?.description,
                                        '[Product].',
                                        'Product'
                                      )
                                    "
                                    for=""
                                  >
                                    {{
                                      this.getAttributeObjectById(
                                        attr?.get("attributeId").value
                                      )?.description
                                    }}</label
                                  >
                                  <div class="attribute-input">
                                    <mat-icon
                                      *ngIf="!attr?.get('isHidden').value"
                                      (click)="toggleVisibility(attr, true)"
                                      class="visibility"
                                      >visibility
                                    </mat-icon>
                                    <mat-icon
                                      *ngIf="attr?.get('isHidden').value"
                                      (click)="toggleVisibility(attr, false)"
                                      class="visibility_off"
                                      >visibility_off
                                    </mat-icon>
                                    <input
                                      type="text"
                                      formControlName="attributeValueExpression"
                                      [ngClass]="{
                                        highlight:
                                          currentFocusedIndex == i + 'Product'
                                      }"
                                      (input)="
                                        formula(
                                          attr?.get('attributeValueExpression'),
                                          i + 'Product'
                                        )
                                      "
                                      (focus)="
                                        formula(
                                          attr?.get('attributeValueExpression'),
                                          i + 'Product'
                                        )
                                      "
                                      placeholder="Enter your value"
                                    />
                                    <ng-container
                                      *ngIf="
                                        getAttributeTypeObjectById(
                                          this.getAttributeObjectById(
                                            attr?.get('attributeId').value
                                          )?.attributeTypeId
                                        )?.availableUOMs?.length > 0
                                      "
                                    >
                                      <select class="bg-light"
                                        tabindex="-1"
                                        *ngIf="
                                          !['Number', 'String'].includes(
                                            getAttributeTypeObjectById(
                                              getAttributeObjectById(
                                                attr?.get('attributeId').value
                                              )?.attributeTypeId
                                            ).description
                                          )
                                        "
                                        formControlName="userConversionUom"
                                        id="userConversionUom"
                                      >
                                        <option
                                          [value]="uom.description"
                                          *ngFor="
                                            let uom of getAttributeTypeObjectById(
                                              this.getAttributeObjectById(
                                                attr?.get('attributeId').value
                                              )?.attributeTypeId,
                                              attr?.get('userConversionUom')
                                            ).availableUOMs
                                          "
                                        >
                                          {{ uom?.description }}
                                        </option>
                                      </select>
                                    </ng-container>

                                    <ng-container
                                      *ngIf="
                                        ['Number', 'String'].includes(
                                          getAttributeTypeObjectById(
                                            getAttributeObjectById(
                                              attr?.get('attributeId').value
                                            )?.attributeTypeId
                                          ).description
                                        )
                                      "
                                    >
                                      <div class="uom-label">
                                        {{
                                          attr?.get("userConversionUom")
                                            .value ?? ""
                                        }}
                                      </div>
                                    </ng-container>
                                  </div>
                                    <dadyin-button matTooltip="Delete" 
                              (clicked)="onDragRemoveAttribute(i, attr)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                                </div>
                              </div>
                            </ng-container>

                            <ng-container
                              *ngIf="
                                ['Toggle'].includes(
                                  getAttributeTypeObjectById(
                                    this.getAttributeObjectById(
                                      attr?.get('attributeId').value
                                    )?.attributeTypeId
                                  )?.description
                                )
                              "
                            >
                              <div
                                [ngClass]="{
                                  'width-perc-25':
                                    attr?.get('colSpace').value == 25,
                                  'width-perc-50':
                                    attr?.get('colSpace').value == 50,
                                  'width-perc-75':
                                    attr?.get('colSpace').value == 75,
                                  'width-perc-100':
                                    attr?.get('colSpace').value == 100
                                }"
                                class="mt-3"
                              >
                                <div class="attribute tabular-sheet d-flex attr-b">
                                  <div class="attribute-input ms-2">
                                    <mat-icon
                                      *ngIf="!attr?.get('isHidden').value"
                                      (click)="toggleVisibility(attr, true)"
                                      class="visibility"
                                      >visibility
                                    </mat-icon>
                                    <mat-icon
                                      *ngIf="attr?.get('isHidden').value"
                                      (click)="toggleVisibility(attr, false)"
                                      class="visibility_off"
                                      >visibility_off
                                    </mat-icon>
                                    <input
                                      type="text"
                                      [value]="
                                        this.getAttributeObjectById(
                                          attr?.get('attributeId').value
                                        )?.description
                                      "
                                      readonly
                                    />
                                    <div class="toggle">
                                      <button
                                        [ngClass]="{
                                          active:
                                            getArray(
                                              attr.get(
                                                'attributeValueExpression'
                                              ).value
                                            )[0].selected == true
                                        }"
                                      >
                                        {{
                                          getArray(
                                            attr.get("attributeValueExpression")
                                              .value
                                          )[0].choice
                                        }}
                                      </button>
                                      <button
                                        [ngClass]="{
                                          active:
                                            getArray(
                                              attr.get(
                                                'attributeValueExpression'
                                              ).value
                                            )[1].selected == true
                                        }"
                                      >
                                        {{
                                          getArray(
                                            attr.get("attributeValueExpression")
                                              .value
                                          )[1].choice
                                        }}
                                      </button>
                                   
                                    </div>
                                  </div>
                                     <dadyin-button matTooltip="Delete" 
                              (clicked)="onDragRemoveAttribute(i, attr)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                                </div>
                              </div>
                            </ng-container>

                            <ng-container
                              *ngIf="
                                ['Dropdown'].includes(
                                  getAttributeTypeObjectById(
                                    this.getAttributeObjectById(
                                      attr?.get('attributeId').value
                                    )?.attributeTypeId
                                  )?.description
                                )
                              "
                            >
                              <div
                                [ngClass]="{
                                  'width-perc-25':
                                    attr?.get('colSpace').value == 25,
                                  'width-perc-50':
                                    attr?.get('colSpace').value == 50,
                                  'width-perc-75':
                                    attr?.get('colSpace').value == 75,
                                  'width-perc-100':
                                    attr?.get('colSpace').value == 100
                                }"
                                class="mt-3"
                              >
                                <div class="attribute one attr-b">
                                  <label
                                    (mousedown)="preventFocusChange($event)"
                                    (click)="
                                      onClickLabel(
                                        this.getAttributeObjectById(
                                          attr?.get('attributeId').value
                                        )?.description,
                                        '[Product].',
                                        'Product'
                                      )
                                    "
                                    for=""
                                  >
                                    {{
                                      this.getAttributeObjectById(
                                        attr?.get("attributeId").value
                                      )?.description
                                    }}</label
                                  >
                                  <div class="attribute-input">
                                    <mat-icon
                                      *ngIf="!attr?.get('isHidden').value"
                                      (click)="toggleVisibility(attr, true)"
                                      class="visibility"
                                      >visibility
                                    </mat-icon>
                                    <mat-icon
                                      *ngIf="attr?.get('isHidden').value"
                                      (click)="toggleVisibility(attr, false)"
                                      class="visibility_off"
                                      >visibility_off
                                    </mat-icon>
                                    <select class="width-perc-100 bg-white">
                                      <option
                                        *ngFor="
                                          let opt of getArray(
                                            attr.get('attributeValueExpression')
                                              .value
                                          )
                                        "
                                        [value]="opt.choice"
                                      >
                                        {{ opt.choice }}
                                      </option>
                                    </select>
                                  </div>
                                      <dadyin-button matTooltip="Delete" 
                              (clicked)="onDragRemoveAttribute(i, attr)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                                </div>
                              </div>
                            </ng-container>
                          </ng-container>
                        </ng-container>
                  
                            <dadyin-button matTooltip="Delete" 
                              (clicked)="removeProductCalculatorAttribute(i)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                      </div>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </ng-container>

              <ng-container *ngIf="excelView[0]">
                <table
                  cdkDropList
                  (cdkDropListDropped)="
                    drop(
                      $event,
                      productCalculatorTemplateAttributeValues.controls
                    )
                  "
                >
                  <ng-container
                    [formGroup]="item"
                    *ngFor="
                      let item of productCalculatorTemplateAttributeValues.controls
                        | sortFormArray;
                      let i = index
                    "
                  >
                    <tr
                      cdkDrag
                      *ngIf="
                        !labelTypeAttributeIds.includes(
                          item.get('attributeId').value
                        )
                      "
                      class="b-light"
                    >
                      <ng-container
                        *ngIf="
                          !['Toggle', 'Dropdown', 'Label'].includes(
                            getAttributeTypeObjectById(
                              this.getAttributeObjectById(
                                attr?.get('attributeId').value
                              )?.attributeTypeId
                            )?.description
                          )
                        "
                      >
                        <td
                          style="
                            width: 200px;
                            padding-left: 10px;
                            white-space: nowrap;
                          "
                        >
                          <div class="d-flex align-items-center">
                            <i class="mr-2 material-icon">drag_indicator</i>
                            <div
                              (mousedown)="preventFocusChange($event)"
                              class="cursor"
                              (click)="
                                onClickLabel(
                                  this.getAttributeObjectById(
                                    item?.get('attributeId').value
                                  )?.description,
                                  '[Product].',
                                  'Product'
                                )
                              "
                            >
                              <b>
                                {{
                                  this.getAttributeObjectById(
                                    item?.get("attributeId").value
                                  )?.description
                                }}
                              </b>
                            </div>
                          </div>
                        </td>
                        <td>
                          <input
                            class="b-light w-100"
                            type="text"
                            (focus)="
                              formula(
                                item?.get('attributeValueExpression'),
                                i + 'Product'
                              )
                            "
                            (input)="
                              formula(
                                item?.get('attributeValueExpression'),
                                i + 'Product'
                              )
                            "
                            formControlName="attributeValueExpression"
                            placeholder="Enter your value"
                          />
                        </td>
                      </ng-container>
                    </tr>
                  </ng-container>
                </table>
              </ng-container>
             
            </div>
          </div>
        </li>
      </ul>
    </section>
  </ng-container> 

  <!-- process calculator layerwise started -->
  <ng-container
    *ngIf="
      lastProcessLayerWiseCalculation?.value == false &&
      templateProcessType.value == 'PROCESS'
    "
  >
    <div class="panel-header my-2 bg-card-header">
      <div class="primary-text">
        <strong>Process Calculator </strong>
      </div>
    </div>

    <ng-container
      [formGroup]="processProduct"
      *ngFor="
        let processProduct of lastProcessProcessProducts?.controls;
        let i = index
      "
    >
      <div class="toolbar padding-bar my-2 grid-2 b-round width-perc-100">
        <div class="font-size-14 primary-text">
          <strong> Layer {{ i }} </strong>
        </div>

        <div class="attribute-group d-flex align-items-center">
          <input
            readonly
            [value]="getNameOfProduct(processProduct.get('subProductId').value)"
            type="text"
          />
        </div>
        <div class="d-flex">
          <div class="primary-text">
            <strong>Layer {{ i }} Cost : </strong>
            <span
              (mousedown)="preventFocusChange($event)"
              (click)="
                onClickLabel(
                  'MetricCost',
                  '[Process].[Layer][' + i + '].',
                  'Layer' + i
                )
              "
              class="price-text cursor"
            >
              {{
                processProduct.get("subProductMetricCost").get("attributeValue")
                  .value
              }}
              {{
                processProduct
                  .get("subProductMetricCost")
                  .get("userConversionUom").value
              }}
            </span>
          </div>
          <div class="primary-text mx-2">
            <strong>Layer {{ i }} Density : </strong>
            <span
              (mousedown)="preventFocusChange($event)"
              (click)="
                onClickLabel(
                  'Density',
                  '[Process].[Layer][' + i + '].',
                  'Layer' + i
                )
              "
              class="price-text cursor"
            >
              {{
                processProduct.get("subProductDensity").get("attributeValue")
                  .value
              }}
              {{
                processProduct.get("subProductDensity").get("userConversionUom")
                  .value
              }}
            </span>
          </div>
        </div>
        <div class="options justify-content-end">
          <div class="d-flex" *ngIf="attributeNameArray?.length > 0">
            <input
              [formControl]="attributeNameArray[i]"
              [matAutocomplete]="auto"
              type="text"
              placeholder="Type new field to add"
            />
            <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete">
              <mat-option
                (click)="setAttributeTypeInArray(i)"
                *ngFor="
                  let attribute of getFilteredAttributesforLayer(i)
                    | SortNamePipe : 'description'
                "
                [value]="attribute.description"
              >
                {{ attribute.description }}
              </mat-option>
            </mat-autocomplete>
            <select
              class="width-perc-100 b-round"
              [formControl]="attributeTypeArray[i]"
            >
              <option value="null" selected>Attribute Type</option>
              <option
                [value]="attributeType.id"
                *ngFor="
                  let attributeType of this.apiService.allAttributesTypes
                    | SortNamePipe : 'description'
                "
              >
                {{ attributeType.description }}
              </option>
            </select>
          </div>
          <div class="px-1">
            <select class="b-round" [formControl]="colSpace">
              <option value="" selected disabled>Field Space</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="75">75</option>
              <option value="100">100</option>
            </select>
          </div>
          <dadyin-button
            class="px-1"
            label="Add"
            [theme]="'primary'"
            [isDisabled]="
              !attributeTypeArray[i].value || !attributeNameArray[i].value
            "
            (clicked)="addAttribute('process', i)"
          >
          </dadyin-button>
          <dadyin-button
            (clicked)="openLayerAttributeDialog(i)"
            [theme]="'borderless-primary'"
            class="bg-white sort-btn"
            type="icon"
            [typeval]="'sort'"
          >
          </dadyin-button>
          <dadyin-button
            (clicked)="changeView(i + 1)"
            [theme]="'borderless-primary'"
            class="bg-white mx-1"
            type="icon"
            [typeval]="'format_list_numbered'"
          >
          </dadyin-button>
        </div>
      </div>
      <section
        class="card my-2"
        style="overflow: auto; max-height: 500px; margin-bottom: 60px"
      >
        <ul class="attribute-groups">
          <li class="attribute-group">
            <div class="d-flex w-100">
              <div
                class="row py-3 w-100"
                *ngIf="getProcessProductAttributeValues(i).controls?.length > 0"
              >
                <ng-container *ngIf="!excelView[i + 1]">
                  <ng-container
                    [formGroup]="processProductAttribute"
                    *ngFor="
                      let processProductAttribute of getProcessProductAttributeValues(
                        i
                      ).controls | sortFormArray;
                      let j = index
                    "
                  >
                    <ng-container
                      *ngIf="
                        !layerWiselabelTypeAttributeIds[
                          processProduct?.value.subProductId + '' + i
                        ]?.includes(
                          processProductAttribute?.get('attributeId').value
                        )
                      "
                    >
                      <ng-container
                        *ngIf="
                          !['Toggle', 'Dropdown', 'Label'].includes(
                            getAttributeTypeObjectById(
                              this.getAttributeObjectById(
                                processProductAttribute?.get('attributeId')
                                  .value
                              )?.attributeTypeId
                            )?.description
                          )
                        "
                      >
                        <div
                          [ngClass]="{
                            'width-perc-25':
                              processProductAttribute?.get('colSpace').value ==
                              25,
                            'width-perc-50':
                              processProductAttribute?.get('colSpace').value ==
                              50,
                            'width-perc-75':
                              processProductAttribute?.get('colSpace').value ==
                              75,
                            'width-perc-100':
                              processProductAttribute?.get('colSpace').value ==
                              100
                          }"
                          class="my-1"
                        >
                          <div class="attribute one attr-b">
                            <label
                              (mousedown)="preventFocusChange($event)"
                              (click)="
                                onClickLabel(
                                  this.getAttributeObjectById(
                                    processProductAttribute.get('attributeId')
                                      .value
                                  )?.description,
                                  '[Process].[Layer][' + i + '].',
                                  'Layer' + i
                                )
                              "
                              for=""
                            >
                              {{
                                this.getAttributeObjectById(
                                  processProductAttribute?.get("attributeId")
                                    .value
                                )?.description
                              }}</label
                            >
                            <div class="attribute-input">
                              <mat-icon
                                (click)="
                                  onDragClickProcessAttribute(
                                    i,
                                    j,
                                    processProduct?.value.subProductId
                                  )
                                "
                                class="more_vert"
                                >more_vert
                              </mat-icon>
                              <mat-icon
                                *ngIf="
                                  !processProductAttribute?.get('isHidden')
                                    .value
                                "
                                (click)="
                                  toggleVisibility(
                                    processProductAttribute,
                                    true
                                  )
                                "
                                class="visibility"
                                >visibility
                              </mat-icon>
                              <mat-icon
                                *ngIf="
                                  processProductAttribute?.get('isHidden').value
                                "
                                (click)="
                                  toggleVisibility(
                                    processProductAttribute,
                                    false
                                  )
                                "
                                class="visibility_off"
                              >
                                visibility_off
                              </mat-icon>

                              <input
                                type="text"
                                [ngClass]="{
                                  highlight:
                                    currentFocusedIndex == j + 'Layer' + i
                                }"
                                (focus)="
                                  formula(
                                    processProductAttribute?.get(
                                      'attributeValueExpression'
                                    ),
                                    j + 'Layer' + i
                                  )
                                "
                                (input)="
                                  formula(
                                    processProductAttribute?.get(
                                      'attributeValueExpression'
                                    ),
                                    j + 'Layer' + i
                                  )
                                "
                                formControlName="attributeValueExpression"
                                placeholder="Enter your value"
                              />
                              <ng-container
                                *ngIf="
                                  getAttributeTypeObjectById(
                                    this.getAttributeObjectById(
                                      processProductAttribute?.get(
                                        'attributeId'
                                      ).value
                                    )?.attributeTypeId
                                  )?.availableUOMs?.length > 0
                                "
                              >
                                <select class="bg-light"
                                  tabindex="-1"
                                  *ngIf="
                                    !['Number', 'String'].includes(
                                      getAttributeTypeObjectById(
                                        getAttributeObjectById(
                                          processProductAttribute?.get(
                                            'attributeId'
                                          ).value
                                        )?.attributeTypeId
                                      ).description
                                    )
                                  "
                                  formControlName="userConversionUom"
                                  id="userConversionUom"
                                >
                                  <option
                                    [value]="uom.description"
                                    *ngFor="
                                      let uom of getAttributeTypeObjectById(
                                        this.getAttributeObjectById(
                                          processProductAttribute?.get(
                                            'attributeId'
                                          ).value
                                        )?.attributeTypeId,
                                        processProductAttribute?.get(
                                          'userConversionUom'
                                        )
                                      ).availableUOMs
                                    "
                                  >
                                    {{ uom?.description }}
                                  </option>
                                </select>
                              </ng-container>

                              <ng-container
                                *ngIf="
                                  ['Number', 'String'].includes(
                                    getAttributeTypeObjectById(
                                      getAttributeObjectById(
                                        processProductAttribute?.get(
                                          'attributeId'
                                        ).value
                                      )?.attributeTypeId
                                    ).description
                                  )
                                "
                              >
                                <div class="uom-label">
                                  {{
                                    processProductAttribute?.get(
                                      "userConversionUom"
                                    ).value ?? ""
                                  }}
                                </div>
                              </ng-container>
                            </div>
                          <!--   <i
                              class="cancel_outline_new material-icon"
                              (click)="removeProcessProductAttribute(i, j)"
                            >
                              cancel_outline
                            </i> -->
                               <dadyin-button matTooltip="Delete" 
                              (clicked)="removeProcessProductAttribute(i, j)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                          </div>
                        </div>
                      </ng-container>

                      <ng-container
                        *ngIf="
                          ['Toggle'].includes(
                            getAttributeTypeObjectById(
                              this.getAttributeObjectById(
                                processProductAttribute?.get('attributeId')
                                  .value
                              )?.attributeTypeId
                            )?.description
                          )
                        "
                      >
                        <div
                          [ngClass]="{
                            'width-perc-25':
                              processProductAttribute.get('colSpace').value ==
                              25,
                            'width-perc-50':
                              processProductAttribute.get('colSpace').value ==
                              50,
                            'width-perc-75':
                              processProductAttribute.get('colSpace').value ==
                              75,
                            'width-perc-100':
                              processProductAttribute.get('colSpace').value ==
                              100
                          }"
                          class="my-1"
                        >
                          <div class="attribute tabular-sheet d-flex attr-b">
                            <div class="attribute-input ms-2">
                              <mat-icon
                                (click)="
                                  onDragClickProcessAttribute(
                                    i,
                                    j,
                                    processProduct?.value.subProductId
                                  )
                                "
                                class="more_vert"
                                >more_vert
                              </mat-icon>
                              <mat-icon
                                *ngIf="
                                  !processProductAttribute?.get('isHidden')
                                    .value
                                "
                                (click)="
                                  toggleVisibility(
                                    processProductAttribute,
                                    true
                                  )
                                "
                                class="visibility"
                                >visibility
                              </mat-icon>
                              <mat-icon
                                *ngIf="
                                  processProductAttribute?.get('isHidden').value
                                "
                                (click)="
                                  toggleVisibility(
                                    processProductAttribute,
                                    false
                                  )
                                "
                                class="visibility_off"
                              >
                                visibility_off
                              </mat-icon>
                              <input
                                type="text"
                                [value]="
                                  this.getAttributeObjectById(
                                    processProductAttribute?.get('attributeId')
                                      .value
                                  )?.description
                                "
                                readonly
                              />
                              <div class="toggle">
                                <button
                                  [ngClass]="{
                                    active:
                                      getArray(
                                        processProductAttribute.get(
                                          'attributeValueExpression'
                                        ).value
                                      )[0].selected == true
                                  }"
                                >
                                  {{
                                    getArray(
                                      processProductAttribute.get(
                                        "attributeValueExpression"
                                      ).value
                                    )[0].choice
                                  }}
                                </button>
                                <button
                                  [ngClass]="{
                                    active:
                                      getArray(
                                        processProductAttribute.get(
                                          'attributeValueExpression'
                                        ).value
                                      )[1].selected == true
                                  }"
                                >
                                  {{
                                    getArray(
                                      processProductAttribute.get(
                                        "attributeValueExpression"
                                      ).value
                                    )[1].choice
                                  }}
                                </button>
                              </div>
                            </div>
                           <!--  <i
                              (click)="removeProcessProductAttribute(i, j)"
                              class="cancel_outline_new material-icon"
                            >
                              cancel_outline</i
                            > -->
                               <dadyin-button matTooltip="Delete" 
                              (clicked)="removeProcessProductAttribute(i,j)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                          </div>
                        </div>
                      </ng-container>
                      <ng-container
                        *ngIf="
                          ['Dropdown'].includes(
                            getAttributeTypeObjectById(
                              this.getAttributeObjectById(
                                processProductAttribute?.get('attributeId')
                                  .value
                              )?.attributeTypeId
                            )?.description
                          )
                        "
                      >
                        <div
                          [ngClass]="{
                            'width-perc-25':
                              processProductAttribute.get('colSpace').value ==
                              25,
                            'width-perc-50':
                              processProductAttribute.get('colSpace').value ==
                              50,
                            'width-perc-75':
                              processProductAttribute.get('colSpace').value ==
                              75,
                            'width-perc-100':
                              processProductAttribute.get('colSpace').value ==
                              100
                          }"
                          class="my-1"
                        >
                          <div class="attribute one attr-b">
                            <label
                              (mousedown)="preventFocusChange($event)"
                              (click)="
                                onClickLabel(
                                  this.getAttributeObjectById(
                                    processProductAttribute?.get('attributeId')
                                      .value
                                  )?.description,
                                  '[Process].[Layer][' + i + '].',
                                  'Layer' + i
                                )
                              "
                              for=""
                            >
                              {{
                                this.getAttributeObjectById(
                                  processProductAttribute?.get("attributeId")
                                    .value
                                )?.description
                              }}</label
                            >
                            <div class="attribute-input">
                              <mat-icon
                                (click)="
                                  onDragClickProcessAttribute(
                                    i,
                                    j,
                                    processProduct?.value.subProductId
                                  )
                                "
                                class="more_vert"
                                >more_vert
                              </mat-icon>
                              <mat-icon
                                *ngIf="
                                  !processProductAttribute?.get('isHidden')
                                    .value
                                "
                                (click)="
                                  toggleVisibility(
                                    processProductAttribute,
                                    true
                                  )
                                "
                                class="visibility"
                                >visibility
                              </mat-icon>
                              <mat-icon
                                *ngIf="
                                  processProductAttribute?.get('isHidden').value
                                "
                                (click)="
                                  toggleVisibility(
                                    processProductAttribute,
                                    false
                                  )
                                "
                                class="visibility_off"
                              >
                                visibility_off
                              </mat-icon>
                              <select class="width-perc-100 bg-white">
                                <option
                                  *ngFor="
                                    let opt of getArray(
                                      processProductAttribute.get(
                                        'attributeValueExpression'
                                      ).value
                                    )
                                  "
                                  [value]="opt.choice"
                                >
                                  {{ opt.choice }}
                                </option>
                              </select>
                            </div>
                         <!--    <i
                              class="cancel_outline_new material-icon"
                              (click)="removeProcessProductAttribute(i, j)"
                            >
                              cancel_outline
                            </i> -->
                              <dadyin-button matTooltip="Delete" 
                              (clicked)="removeProcessProductAttribute(i, j)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                          </div>
                        </div>
                      </ng-container>
                      <ng-container
                        *ngIf="
                          ['Label'].includes(
                            getAttributeTypeObjectById(
                              this.getAttributeObjectById(
                                processProductAttribute?.get('attributeId')
                                  .value
                              )?.attributeTypeId
                            )?.description
                          )
                        "
                      >
                        <div
                          class="width-perc-100 row b-all b-round mx-auto min-h-label p-0 my-2 relative"
                        >
                          <div class="labeltype-attribute">
                            {{
                              this.getAttributeObjectById(
                                processProductAttribute?.get("attributeId")
                                  .value
                              )?.description
                            }}
                          </div>

                          <ng-container
                            [formGroup]="attr"
                            *ngFor="
                              let attr of filterAttributeForLayerWiseLabel(
                                getProcessProductAttributeValues(i),
                                processProduct?.value.subProductId,
                                i
                              ) | sortFormArray
                            "
                          >
                            <ng-container>
                              <ng-container
                                *ngIf="
                                  !['Toggle', 'Dropdown', 'Label'].includes(
                                    getAttributeTypeObjectById(
                                      this.getAttributeObjectById(
                                        attr?.get('attributeId').value
                                      )?.attributeTypeId
                                    )?.description
                                  )
                                "
                              >
                                <div
                                  [ngClass]="{
                                    'width-perc-25':
                                      attr?.get('colSpace').value == 25,
                                    'width-perc-50':
                                      attr?.get('colSpace').value == 50,
                                    'width-perc-75':
                                      attr?.get('colSpace').value == 75,
                                    'width-perc-100':
                                      attr?.get('colSpace').value == 100
                                  }"
                                  class="mt-3"
                                >
                                  <div class="attribute one attr-b">
                                    <label
                                      (mousedown)="preventFocusChange($event)"
                                      (click)="
                                        onClickLabel(
                                          this.getAttributeObjectById(
                                            attr?.get('attributeId').value
                                          )?.description,
                                          '[Process].[Layer][' + i + '].',
                                          'Layer' + i
                                        )
                                      "
                                      for=""
                                    >
                                      {{
                                        this.getAttributeObjectById(
                                          attr?.get("attributeId").value
                                        )?.description
                                      }}
                                    </label>
                                    <div class="attribute-input">
                                      <mat-icon
                                        *ngIf="!attr?.get('isHidden').value"
                                        (click)="toggleVisibility(attr, true)"
                                        class="visibility"
                                        >visibility
                                      </mat-icon>
                                      <mat-icon
                                        *ngIf="attr?.get('isHidden').value"
                                        (click)="toggleVisibility(attr, false)"
                                        class="visibility_off"
                                        >visibility_off
                                      </mat-icon>
                                      <input
                                        type="text"
                                        formControlName="attributeValueExpression"
                                        [ngClass]="{
                                          highlight:
                                            currentFocusedIndex ==
                                            j + 'Layer' + i
                                        }"
                                        (input)="
                                          formula(
                                            attr?.get(
                                              'attributeValueExpression'
                                            ),
                                            j + 'Layer' + i
                                          )
                                        "
                                        (focus)="
                                          formula(
                                            attr?.get(
                                              'attributeValueExpression'
                                            ),
                                            j + 'Layer' + i
                                          )
                                        "
                                        placeholder="Enter your value"
                                      />
                                      <ng-container
                                        *ngIf="
                                          getAttributeTypeObjectById(
                                            this.getAttributeObjectById(
                                              attr?.get('attributeId').value
                                            )?.attributeTypeId
                                          )?.availableUOMs?.length > 0
                                        "
                                      >
                                        <select class="bg-light"
                                          tabindex="-1"
                                          *ngIf="
                                            !['Number', 'String'].includes(
                                              getAttributeTypeObjectById(
                                                getAttributeObjectById(
                                                  attr?.get('attributeId').value
                                                )?.attributeTypeId
                                              ).description
                                            )
                                          "
                                          formControlName="userConversionUom"
                                          id="userConversionUom"
                                        >
                                          <option
                                            [value]="uom.description"
                                            *ngFor="
                                              let uom of getAttributeTypeObjectById(
                                                this.getAttributeObjectById(
                                                  attr?.get('attributeId').value
                                                )?.attributeTypeId,
                                                attr?.get('userConversionUom')
                                              ).availableUOMs
                                            "
                                          >
                                            {{ uom?.description }}
                                          </option>
                                        </select>
                                      </ng-container>

                                      <ng-container
                                        *ngIf="
                                          ['Number', 'String'].includes(
                                            getAttributeTypeObjectById(
                                              getAttributeObjectById(
                                                attr?.get('attributeId').value
                                              )?.attributeTypeId
                                            ).description
                                          )
                                        "
                                      >
                                        <div class="uom-label">
                                          {{
                                            attr?.get("userConversionUom")
                                              .value ?? ""
                                          }}
                                        </div>
                                      </ng-container>
                                    </div>
                                  <!--   <i
                                      class="cancel_outline_new material-icon"
                                      (click)="
                                        onDragRemoveProcessAttribute(
                                          i,
                                          j,
                                          attr,
                                          processProduct?.value.subProductId
                                        )
                                      "
                                      >cancel_outline</i
                                    > -->
                                      <dadyin-button matTooltip="Delete" 
                              (clicked)="
                                        onDragRemoveProcessAttribute(
                                          i,
                                          j,
                                          attr,
                                          processProduct?.value.subProductId
                                        )
                                      "
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                                  </div>
                                </div>
                              </ng-container>

                              <ng-container
                                *ngIf="
                                  ['Toggle'].includes(
                                    getAttributeTypeObjectById(
                                      this.getAttributeObjectById(
                                        attr?.get('attributeId').value
                                      )?.attributeTypeId
                                    )?.description
                                  )
                                "
                              >
                                <div
                                  [ngClass]="{
                                    'width-perc-25':
                                      attr?.get('colSpace').value == 25,
                                    'width-perc-50':
                                      attr?.get('colSpace').value == 50,
                                    'width-perc-75':
                                      attr?.get('colSpace').value == 75,
                                    'width-perc-100':
                                      attr?.get('colSpace').value == 100
                                  }"
                                  class="mt-3"
                                >
                                  <div class="attribute tabular-sheet attr-b">
                                    <div class="attribute-input">
                                      <mat-icon
                                        *ngIf="!attr?.get('isHidden').value"
                                        (click)="toggleVisibility(attr, true)"
                                        class="visibility"
                                        >visibility
                                      </mat-icon>
                                      <mat-icon
                                        *ngIf="attr?.get('isHidden').value"
                                        (click)="toggleVisibility(attr, false)"
                                        class="visibility_off"
                                        >visibility_off
                                      </mat-icon>
                                      <input
                                        type="text"
                                        [value]="
                                          this.getAttributeObjectById(
                                            attr?.get('attributeId').value
                                          )?.description
                                        "
                                        readonly
                                      />
                                      <div class="toggle">
                                        <button
                                          [ngClass]="{
                                            active:
                                              getArray(
                                                attr.get(
                                                  'attributeValueExpression'
                                                ).value
                                              )[0].selected == true
                                          }"
                                        >
                                          {{
                                            getArray(
                                              attr.get(
                                                "attributeValueExpression"
                                              ).value
                                            )[0].choice
                                          }}
                                        </button>
                                        <button
                                          [ngClass]="{
                                            active:
                                              getArray(
                                                attr.get(
                                                  'attributeValueExpression'
                                                ).value
                                              )[1].selected == true
                                          }"
                                        >
                                          {{
                                            getArray(
                                              attr.get(
                                                "attributeValueExpression"
                                              ).value
                                            )[1].choice
                                          }}
                                        </button>
                                      </div>
                                    </div>
                                  <!--   <i
                                      (click)="
                                        onDragRemoveProcessAttribute(
                                          i,
                                          j,
                                          attr,
                                          processProduct?.value.subProductId
                                        )
                                      "
                                      class="cancel_outline_new material-icon"
                                    >
                                      cancel_outline
                                    </i> -->
                                      <dadyin-button matTooltip="Delete" 
                              (clicked)="
                                        onDragRemoveProcessAttribute(
                                          i,
                                          j,
                                          attr,
                                          processProduct?.value.subProductId
                                        )
                                      "
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                                  </div>
                                </div>
                              </ng-container>

                              <ng-container
                                *ngIf="
                                  ['Dropdown'].includes(
                                    getAttributeTypeObjectById(
                                      this.getAttributeObjectById(
                                        attr?.get('attributeId').value
                                      )?.attributeTypeId
                                    )?.description
                                  )
                                "
                              >
                                <div
                                  [ngClass]="{
                                    'width-perc-25':
                                      attr?.get('colSpace').value == 25,
                                    'width-perc-50':
                                      attr?.get('colSpace').value == 50,
                                    'width-perc-75':
                                      attr?.get('colSpace').value == 75,
                                    'width-perc-100':
                                      attr?.get('colSpace').value == 100
                                  }"
                                  class="mt-3"
                                >
                                  <div class="attribute one attr-b">
                                    <label
                                      (mousedown)="preventFocusChange($event)"
                                      (click)="
                                        onClickLabel(
                                          this.getAttributeObjectById(
                                            attr?.get('attributeId').value
                                          )?.description,
                                          '[Process].[Layer][' + i + '].',
                                          'Layer' + i
                                        )
                                      "
                                      for=""
                                    >
                                      {{
                                        this.getAttributeObjectById(
                                          attr?.get("attributeId").value
                                        )?.description
                                      }}</label
                                    >
                                    <div class="attribute-input">
                                      <mat-icon
                                        *ngIf="!attr?.get('isHidden').value"
                                        (click)="toggleVisibility(attr, true)"
                                        class="visibility"
                                        >visibility
                                      </mat-icon>
                                      <mat-icon
                                        *ngIf="attr?.get('isHidden').value"
                                        (click)="toggleVisibility(attr, false)"
                                        class="visibility_off"
                                        >visibility_off
                                      </mat-icon>
                                      <select class="width-perc-100 bg-white">
                                        <option
                                          *ngFor="
                                            let opt of getArray(
                                              attr.get(
                                                'attributeValueExpression'
                                              ).value
                                            );
                                            trackBy: trackByFn
                                          "
                                          [value]="opt.choice"
                                        >
                                          {{ opt.choice }}
                                        </option>
                                      </select>
                                    </div>
                                  <!--   <i
                                      class="cancel_outline_new material-icon"
                                      (click)="
                                        onDragRemoveProcessAttribute(
                                          i,
                                          j,
                                          attr,
                                          processProduct?.value.subProductId
                                        )
                                      "
                                    >
                                      cancel_outline
                                    </i> -->
                                      <dadyin-button matTooltip="Delete" 
                              (clicked)="
                                        onDragRemoveProcessAttribute(
                                          i,
                                          j,
                                          attr,
                                          processProduct?.value.subProductId
                                        )
                                      "
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                                  </div>
                                </div>
                              </ng-container>
                            </ng-container>
                          </ng-container>

                         <!--  <i
                            class="cancel_outline_new material-icon"
                            (click)="removeProcessProductAttribute(i, j)"
                          >
                            cancel_outline
                          </i> -->
                            <dadyin-button matTooltip="Delete" 
                              (clicked)="removeProcessProductAttribute(i, j)"
                               [theme]="'borderless-danger'"
          type="image" [typeval]="'assets/nicons/delete.png'">
        </dadyin-button>
                        </div>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                </ng-container>

                <ng-container *ngIf="excelView[i + 1]">
                  <table
                    cdkDropList
                    (cdkDropListDropped)="
                      drop($event, getProcessProductAttributeValues(i).controls)
                    "
                  >
                    <ng-container
                      [formGroup]="processProductAttribute"
                      *ngFor="
                        let processProductAttribute of getProcessProductAttributeValues(
                          i
                        ).controls | sortFormArray;
                        let j = index
                      "
                    >
                      <ng-container
                        *ngIf="
                          !layerWiselabelTypeAttributeIds[
                            processProduct?.value.subProductId + '' + i
                          ]?.includes(
                            processProductAttribute?.get('attributeId').value
                          )
                        "
                      >
                        <ng-container
                          *ngIf="
                            !['Toggle', 'Dropdown', 'Label'].includes(
                              getAttributeTypeObjectById(
                                this.getAttributeObjectById(
                                  processProductAttribute?.get('attributeId')
                                    .value
                                )?.attributeTypeId
                              )?.description
                            )
                          "
                        >
                          <ng-container>
                            <tr cdkDrag class="b-light">
                              <td
                                style="
                                  width: 200px;
                                  padding-left: 10px;
                                  white-space: nowrap;
                                "
                              >
                                <div class="d-flex align-items-center">
                                  <i class="mr-2 material-icon"
                                    >drag_indicator</i
                                  >
                                  <div
                                    (mousedown)="preventFocusChange($event)"
                                    class="cursor"
                                    (click)="
                                      onClickLabel(
                                        this.getAttributeObjectById(
                                          processProductAttribute.get(
                                            'attributeId'
                                          ).value
                                        )?.description,
                                        '[Process].[Layer][' + i + '].',
                                        'Layer' + i
                                      )
                                    "
                                  >
                                    <b>
                                      {{
                                        this.getAttributeObjectById(
                                          processProductAttribute?.get(
                                            "attributeId"
                                          ).value
                                        )?.description
                                      }}
                                    </b>
                                  </div>
                                </div>
                              </td>
                              <td>
                                <input
                                  class="b-light w-100"
                                  type="text"
                                  [ngClass]="{
                                    highlight:
                                      currentFocusedIndex == j + 'Layer' + i
                                  }"
                                  (focus)="
                                    formula(
                                      processProductAttribute?.get(
                                        'attributeValueExpression'
                                      ),
                                      j + 'Layer' + i
                                    )
                                  "
                                  (input)="
                                    formula(
                                      processProductAttribute?.get(
                                        'attributeValueExpression'
                                      ),
                                     j + 'Layer' + i
                                    )
                                  "
                                  formControlName="attributeValueExpression"
                                  placeholder="Enter your value"
                                />
                              </td>
                            </tr>
                          </ng-container>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                  </table>
                </ng-container>
              </div>
            </div>
          </li>
        </ul>
      </section>
    </ng-container>
  </ng-container>
  <!-- process calculator layerwise ended-->

  <!-- Selection Area -->
  <!-- <section class="card">
    <div class="selection-area">
      <h3 class="selection-area-heading">Selection Area </h3>
      <p class="selection-area-sub-heading">
        Choose attributes to use in the formulas
      </p>
    </div>

    <div class="selection-area-body">
      <ng-container *ngFor="let i of [0]">
        <table>
          <thead>
            <tr>
              <th>Extra Expenses Attributes</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Extra expenses /Unit</td>
            </tr>
            <tr>
              <td>Weight</td>
            </tr>
            <tr>
              <td>Volume</td>
            </tr>
            <tr>
              <td>Labour/Unit</td>
            </tr>
            <tr>
              <td>Labour/MT</td>
            </tr>
            <tr>
              <td>Electricity/MT</td>
            </tr>
          </tbody>
        </table>
      </ng-container>
    </div>
  </section> -->
</form>
