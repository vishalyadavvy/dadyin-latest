<mat-tab-group
  class="mat-steps"
  [selectedIndex]="currentMainIndex"
  (selectedIndexChange)="changeMainTab($event)"
>
  <mat-tab *ngFor="let link of mainTab">
    <ng-template mat-tab-label>
      <span
        [matBadge]="link.badge"
        [matBadgeHidden]="link.badge === 0"
        [matBadgeOverlap]="false"
        >{{ link.title }}</span
      >
    </ng-template>
    <ng-template matTabContent>
      <ng-container *ngIf="currentMainIndex == 0">
        <ng-container>
          <div class="header-wrapper mt-2">
            <div class="d-flex">
              <div class="col-6">
                <div class="filters d-flex w-100 align-items-center">
                  <search-filter
                    [searchControl]="searchControl"
                    style="width: 100%"
                    (inputChange)="onInput($event)"
                    [placeholder]="
                      'Search based on Product Type/ SubType/ Product name & code'
                    "
                  ></search-filter>
                  <app-filter-box
                    [products]="productsList"
                    (emitFilterProducts)="filterProducts($event)"
                  ></app-filter-box>
                </div>
              </div>
              <div class="col-6 d-flex justify-content-end align-items-center">
                <div class="action-btns">
                  <dadyin-button
                    [theme]="'primary'"
                    label="Add Product"
                    (clicked)="addProduct()"
                  >
                  </dadyin-button>
                  <dadyin-button
                    [theme]="'secondary'"
                    label="Add Raw Material"
                    (clicked)="addRawMaterial()"
                    style="margin-left: 10px"
                  >
                  </dadyin-button>
                </div>
              </div>
            </div>
          </div>

          <div cdkDrag class="uom-config-section">
            <button
              (click)="$event.stopPropagation(); uomSetting = !uomSetting"
              class="btn bg-primary-light title-text"
            >
              UOM Setting
            </button>
            <div
              (click)="$event.stopPropagation()"
              class="card uom-card"
              *ngIf="uomSetting"
            >
              <div
                style="margin: 15px"
                class="prefer-uom-grid align-items-center"
                *ngIf="componentUoms.controls?.length > 0"
              >
                <div
                  [formGroup]="item"
                  *ngFor="let item of componentUoms.controls; let i = index"
                  class="my-2 attribute one b-none w-100"
                >
                  <div
                    class="attribute-input justify-content-around w-100 title-text"
                  >
                    <div class="text-uppercase">
                      {{ item.get("attributeName").value }}
                    </div>
                    <select
                      (change)="loadProductsList()"
                      formControlName="userConversionUom"
                    >
                      <ng-container
                        *ngFor="
                          let uom of uomService.getUoms(
                            item.get('attributeTypeId').value
                          )
                        "
                      >
                        <option [value]="uom.description">
                          {{ uom?.description }}
                        </option>
                      </ng-container>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="content-wrapper mt-2">
            <data-table
              [data]="productsList"
              [headers]="headers"
              [pageConfig]="pageConfig"
              (editData)="editRecord($event)"
              (sortChange)="sort($event)"
              (pageChange)="pageChange($event)"
              [actions]="tabelActions"
              (actionClick)="onActionClick($event)"
              (uomChange)="loadProductListByUOM($event)"
              (tooltipShow)="showPopover($event.row, $event.event, $event.prop)"
              (tooltipHide)="hidePopover()"
              [tooltipContent]="salesTooltip"
            >
            </data-table>
          </div>
        </ng-container>
      </ng-container>
      <ng-container *ngIf="currentMainIndex == 1"> </ng-container>
      <ng-container *ngIf="currentMainIndex == 2"> </ng-container>
      <ng-container *ngIf="currentMainIndex == 3"> </ng-container>
    </ng-template>
  </mat-tab>
</mat-tab-group>

<!-- Tooltip Templates -->
<ng-template #salesTooltip>
  <div class="prev-sales-tooltip" style="max-width: 400px; width: 400px">
    <div class="tooltip-header">
      <span class="tooltip-title">{{ labelTooltip }}</span>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-content">
      <div class="spinner"></div>
      <span>Loading...</span>
    </div>

    <!-- Sales Data Table -->
    <div *ngIf="!loading && salesData.length > 0" class="sales-data">
      <table class="sales-table" style="width: 100%; table-layout: fixed">
        <thead>
          <tr>
            <th style="width: 25%">Date</th>
            <th style="width: 15%">Qty</th>
            <th style="width: 20%">Price</th>
            <th style="width: 40%">
              {{ labelTooltip == "Prev. Purchases" ? "Vendor" : "Customer" }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let sale of salesData">
            <td style="font-size: 11px; padding: 4px">{{ sale.date }}</td>
            <td style="font-size: 11px; padding: 4px">
              {{ sale.quantity | number }}
            </td>
            <td style="font-size: 11px; padding: 4px" class="price-cell-green">
              ${{ sale.cost | number : "1.2-2" }}
            </td>
            <td
              style="
                font-size: 11px;
                padding: 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
              "
            >
              {{ labelTooltip == 'Prev. Purchases' ? sale.vendorName : sale.customerName }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- No Data State -->
    <div *ngIf="!loading && salesData.length === 0" class="no-data">
      <span>No previous sales data available</span>
    </div>
  </div>
</ng-template>
